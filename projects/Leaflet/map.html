<!DOCTYPE html>
<html>
	<title>US States</title>
	<head>
		<meta charset="utf-8">
		<title></title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		
		<style>
			#mapid {
				top: 0px;
				height: 50%;
				width: 50%;
				position: fixed
			}
			
			#plot1 {
				position: fixed;
				width: 50%;
				height: 50%;
				top: 0px;
				right: 5px;
				
				backgroun-opacity: .5;
				background-color: #7977F4
			}
			
			#layer_selector {
				position: absolute;
				top: 30px;
				right: 30px;
				z-index: 1000;
			}
			#text {
				position: fixed;
				top:52%
				
			}
		</style>
		
	</head>

	<body>
		
		<div id="mapid"></div>
		
		<div id="plot1"></div>
		<div id="text"> This tool uses Leaflet.js and D3.js to create an interactive map of the states and a chart that updates <br>
						with relevant data when a state is clicked on. The chart data is historical fuel distillate (diesel and other <br>
						types of refined fuel excluding gasoline) sales volume from 1984 to 2015. The data comes from the EIA <br>
						and was cleaned for use with R. The points on the chart highlight and both variables appear when hovered <br>
						over. The y-axis changes according to the range of data for the current state.
						<br>
						<br>
						Fuel distillate data from EIA: <a href="http://www.eia.gov/dnav/pet/pet_cons_821dst_a_EPD0_VTE_Mgal_a.htm" target="_blank">link</a> </div>
		
		<script src="us_state2.js" type="text/javascript"></script>
		<script>
			//Make a nice choropleth of the US states with some intersting info
		
		///////////////////
		//Load data with D3
			var sales
				h = '100%'
				w = '100%'
				sidePadding = 120
				topPadding = 40
			var	yScale;
			var xScale
			var svgClientSize = d3.select('#plot1').append('svg').attr('id','graph').attr('width', w).attr('height', h).node().getBoundingClientRect();
			var timeScale
			
			function loadD3(stateName) {
				d3.csv("sales_wide.tsv", function(data){
					sales=data
									
					
					xScale = d3.scaleLinear()
								.domain([0, sales.length])
								.range([sidePadding, svgClientSize.width-(sidePadding/2)])
					yScale = d3.scaleLinear()
								.domain([0, d3.max(sales, function(d) { return Number(eval("d." + stateName)) })]) //overall max: 7837118
								.range([svgClientSize.height-topPadding,topPadding])
					
					timeScale = d3.scaleTime()
									.domain([ new Date(d3.min(sales, function(d) {return d.Date})), new Date(d3.max(sales, function(d) {return d.Date})) ])
									.range([sidePadding, svgClientSize.width-(sidePadding/2)])
					
					var timeAxis = d3.axisBottom(timeScale)
					
					
					var xAxis = d3.axisBottom(xScale)
					var yAxis = d3.axisLeft(yScale)
					var tooltip = d3.select("body")
										.append("div")
										.attr('class','tooltip')
										.style('color','white')
										.style("position", "absolute")
										.style("z-index", "10")
										//.style("visibility", "hidden")
										
					
					//d3.select('#plot1').append('svg').attr('id','graph').attr('width', w).attr('height', h)
					
					if (!!document.getElementById("graph")) {
						d3.selectAll('#graph').remove()
						} 
					
					d3.select('#plot1').append('svg').attr('id','graph').attr('width', w).attr('height', h)				
							.selectAll('circle')
							.data(sales)
							.enter()
							.append('circle')
								.attr('cy', function(d){ return  yScale(Number(eval("d." + stateName))) })
								.attr('cx', function(d,i){ return xScale(i)})
								.attr('r','.5%')
								//transition
								.on("mouseover", function(d,i){
									d3.select(this)//.select('circle')
										.transition()
										.duration(500)
										.attr('r','1%')
										.attr('fill','white')
									d3.select('.tooltip')
										tooltip.transition()
											.duration(200)
											.style('visibility','visible')
											.style('opacity',1)
										tooltip.html('<b>'+ d.Date + '<br>' + Number(eval("d." + stateName)).toLocaleString()+' thousand gallons </b>')
											.style('font-size','14px')
											.style('font-family','sans-serif')
											.style("left", (d3.event.pageX + 8) + "px")
											.style("top", (d3.event.pageY - 35) + "px");
									})
								.on("mouseout", function(d,i){
									d3.select(this)
										.transition()
										.duration(200)
										.attr('r','.5%')
										.attr('fill','black')
									tooltip.transition()
										.duration(400)
										.style('visibility','hidden')
									d3.select('#hoverCircle')
										.remove()
									
									//tooltip.transition()
									//	.duration(500)
									//	.style('opacity', 0)
									});
								
					
					d3.select('#graph').append('g')
						.attr('transform', 'translate(0,'+ (svgClientSize.height-topPadding) +')')
						.call(timeAxis)
					d3.select('#graph').append('g')
						.attr('transform', 'translate('+ (sidePadding-10) +',0)')
						.call(yAxis)
						
					d3.select('#graph').append('text')
						.attr('x', '50%')
						.attr('y', topPadding/2)
						.attr('text-anchor', 'middle')
						.style('font-size','16px').style('font-family','sans-serif')						
						.text("Sales of Distillate Fuel Oil in " + fullState)
					d3.select('#graph').append('text')
						.attr('text-anchor', 'middle')
						.attr('transform','translate('+(sidePadding/4)+','+(svgClientSize.height/2)+')'+'rotate(-90)')
						.style('font-size','16px').style('font-family','sans-serif')						
						.text("Thousands of Gallons")
				});
			};
			
		///////////////////
		//Start leaflet
			var mymap = L.map('mapid').setView([37.8, -96], 3);
			
			L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 19,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}).addTo(mymap);
			
			function style(feature) {
				return {
					weight: .5,
					opacity: 1,
					color: 'blue',
					//dashArray: '3',
					fillOpacity: 0.5
				};
			}
					
			
			//Hover effect
			
			
			function highlightFeature(e) {
				var layer = e.target;

				layer.setStyle({
					weight: 5,
					color: '#666',
					dashArray: '',
					fillOpacity: 0.7
					});
			};
			
			var geojson;
			
			function resetHighlight(e) {
				geojson.resetStyle(e.target);
			};
			
			function onEachFeature(feature, layer) {
				layer.on({
					mouseover: highlightFeature,
					mouseout: resetHighlight,
					//click: console.log(feature.properties.region)
				});
				layer.bindPopup('<h1>'+feature.properties.region+'</h1>');
				//layer.console.log(feature.properties.region)
			};
			
			function getLayer(feature, layer) {
				layer.console.log(feature.properties.region)
			};
			
			function clickIt(feature, layer) {
				layer.bindPopup("Hi");
			};
			
			geojson = L.geoJson(state, {
						style: style,
						onEachFeature: onEachFeature
					  }).addTo(mymap);
											  
			var clickState
			
			geojson.on('click', function(e) {
				//return e.layer.feature.properties.region 
				clickState = e.layer.feature.properties.query;
				fullState = e.layer.feature.properties.region;
				loadD3(clickState)
			});
			
			
			
		</script>
	</body>
</html>
















