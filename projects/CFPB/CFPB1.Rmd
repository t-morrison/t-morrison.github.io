---
title: "Payday Loans and Customer Service"
author: "T. Morrison"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev='CairoPNG')

```

In this script for the CFPB consumer complaint data, I am going to look at a somewhat contentious financial product that is receiving some extra scrutiny, according to an [NPR Freakonomics Radio show](http://freakonomics.com/podcast/payday-loans/) I heard recently: **payday loans**.

First, loading up the packages and getting the data from the SQL file provided by Kaggle. I'll be using `RSQLite` to query the SQLite database.

```{r error=F, message=F, warning=F}
library(RSQLite)
library(DBI)
library(ggplot2)
library(Cairo)
library(data.table)
library(ggthemes)

con <- dbConnect(SQLite(), "C:/sqlite/kaggle1.sqlite")
x<- data.table(dbReadTable(con, "consumer_complaints"))
```

The dataset has over 500,000 complaints in it, but how many are for payday loans compared to other financial products?

```{r}
ggplot(x, aes(x=product)) +
  geom_bar() +
  geom_bar(data=x[product=="Payday loan"], aes(product), color= "red", fill="red") +
  ggtitle("Complaints by Product") + xlab("") +
  theme_solarized() +
  theme(axis.text.x=element_text(angle=45, vjust=.6))
  

x[, .N, by=product][order(-N)]
```

Only 3877 complaints regarding payday loans to the CFPB, the 8th fewest out of the 11 products in the data. 3877 payday loan complaints compared to 186,475 mortgage complaints; a quick internet search suggested in the neighborhood of 100+ million payday loans a year and about 10 million mortgages. This doesn't seem too bad, considering the reputation of payday loans for gouging people. Let's keep looking.

```{r}
pd <- x[product=="Payday loan"]
```

What issues do people have with payday loans?

```{r}
ggplot(pd, aes(x=issue, fill=)) +
  geom_bar(fill="lightblue3") +
  coord_flip() +
  ggtitle("Complaint Issue, Payday Loans") + xlab("") + ylab("N") +
  theme_solarized(base_size = 14)
```

As you might expect, the biggest complaint related to payday loans is being charged unexpected fees or interest. Critics of payday loans point to the 300 and 400 percent interest rates that borrowers get sucked into when they cannot repay their loans quickly enough.

What does the company have to say when consumers complain about unexpected fees or interest? Using `company_public_response` we can see.

```{r}
pd[issue=="Charged fees or interest I didn't expect", .N, by=company_public_response][order(-N)]
```

If you can follow the annoyingly wrapped output, you'll see that in the vast majority of cases, the company didn't provide a public response. But when they did, 128 out of 246 times they believed they were acting appropriately according to the contract or law (aka you're screwed). 

And what did the companies say to these consumers who complained about unexpected fees or interest?
```{r}
ggplot(pd[issue=="Charged fees or interest I didn't expect"], aes(x=company_response_to_consumer)) +
  geom_bar(fill="lightblue3") +
  coord_flip() +
  ggtitle("Company Response to Unexpected Fees") + xlab("") + ylab("N") +
  theme_solarized(base_size = 14)
```

I'm guessing that explanation did not mean too much to the consumers here.


###Personal Stories

We can get a personal look at some of these complaints through the `consumer_complaint_narrative`, a variable containing the text of the consumer's complaint. Unfortunately this variable is only provided if the consumer explicitly gave consent, and many did not. There are still a good amount though and I will be looking for some keywords within them.

####Lies, damn lies, and statistics
First, did many people feel like they had been lied to or misled regarding their payday loan?

Let's look specifically at the following keywords:

* ' lie' (includes 'lied' but not words like 'applied')
* 'mislead'
* 'misled'
* 'lying'
* ' steal'
* ' stole'


```{r}
pd2 <- pd[!is.na(pd$consumer_complaint_narrative)] #rows that are not NAs

match <- c(" lie", "mislead", " lying", " steal", " stole", "misled")
pdLies <- grepl(paste(match, collapse="|"), pd2$consumer_complaint_narrative)
summary(pdLies)
```

Only 34 of 726 consumers used those keywords in their complaint.

How does this compare to the mortgage complaints?

```{r}
mo <- x[product=="Mortgage"]
mo2 <- mo[!is.na(mo$consumer_complaint_narrative)]

moLies <- grepl(paste(match, collapse="|"), mo2$consumer_complaint_narrative)
summary(moLies)
```
1742 out of 13177...13.2% of mortgage complaints versus 4.7% of payday loan complaints used language about lying, stealing, or misleading.

####Customer service

How do these consumers think of the customer service of their financial institutions? Let's cue up the search for some new keywords. I'll start by looking by `product` in a more comprehensive way than above, by looking across every category at once.

I'll use the keywords:

* 'rude'
* 'insult'
* 'disrespectful'
* 'unhelpful'
* 'unfriendly'

With the code below, I have found the percentage of complaint narratives containing the above keywords by `product`.

```{r}
cs <- c(" rude", "insult", "disrespectful", "unhelpful", "unfriendly") #keywords

x2 <- x[!is.na(x$consumer_complaint_narrative)]  #every row in original dataset containing a narrative

x2[, CS := grepl(paste(cs, collapse="|"),    #new logical column `CS`; TRUE for narratives containing keywords
                 x2$consumer_complaint_narrative)] 

x3 <- x2[, .N, by=.(product, CS)][order(product,CS)] #count number of T/F in `CS`  by `product` and reorder

x3[, Percent := (N/(N+shift(N))), by=product] #calculate (T)/(T + F) to get percentage of complaint narratives
head(x3, n=5)                                 #that contained the keywords, by `product`
```

```{r}
ggplot(x3[!is.na(x3$Percent)], aes(x=product, y= Percent)) +
  geom_bar(stat="identity", fill="lightblue3") +
  ggtitle("Customer Service Complaints by Product") + xlab("") + ylab("Fraction of Total Complaints") +
  theme_solarized() +
  theme(axis.text.x=element_text(angle=45, vjust=.6))
```

Of all the products, consumers complaining about student loans and consumer loans used language indicating displeasure with their interactions with the company at the highest rates, above even debt collection and payday loans.

I will continue with this analysis, perhaps looking at the companies that have the most complaints against them to see how their customer service stacks up. Until next time.


