---
title: "CFPB zip"
author: "T Morrison"
date: "May 26, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev='CairoPNG')
```

Continuing with the CFPB data from the previous two posts, I am now going to look at some variations of the data by location.

```{r, message=TRUE, warning=TRUE, include=FALSE}
library(data.table)
library(ggplot2)
library(ggmap)
library(ggthemes)
library(RSQLite)
library(zipcode)
library(dplyr)
library(maps)
library(scales)
library(mgcv)
```


```{r, include=FALSE}
con <- dbConnect(SQLite(), "C:/sqlite/kaggle1.sqlite")
x<- data.table(dbReadTable(con, "consumer_complaints"))
x$date_received <- as.Date(x$date_received, format="%m/%d/%Y")
x$zipcode <- as.numeric(x$zipcode)
```


###Demographics

Before diving into the map visualizations, I want to check out one variable I haven't looked at- `tags`

```{r}
x[,.N, by=tags]
```
There are only four different classes here, and the majority of observations are "NA" for this type. But there are 37,000 "Older American" observations and 20,000 "Servicember" ones. An older American is someone over 62, according to the CFPB website; a servicemember is anyone in the military or their spouse. This is an interesting variable because it is the only one in the dataset that gives a look into any sort of demographic.

What are older Americans' and servicemembers' complaints about?

First, I want to set up a proportional variable to view how the number of complaints by `product` compares to the total number of complaints for each type in `tags`; I'll also set tha `NA`s in `tags` to "Other".
```{r}
x[is.na(x$tags)]$tags <- "Other"
y <- x[, .N, by=.(tags, product)]
y$prop <- ifelse(y$tags=="Other", y$N/405442, 
                 ifelse(y$tags=="Older American", y$N/37314, 
                        ifelse(y$tags=="Older American, Servicemember", y$N/5256, 
                               ifelse(y$tags=="Servicemember", y$N/20610, NA))))

```

Now, a nice barplot. I'm leaving out "Older American, Servicemember" because there are so few observations there.
```{r}
ggplot(y[tags!="Older American, Servicemember"], aes(x=product, y=prop, fill=tags)) +
  geom_bar(stat="identity", position="dodge") +
  scale_y_continuous(labels=scales::percent) +
  theme_solarized() +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  theme(strip.background=element_rect(fill=NA)) +
  ggtitle("CPFB Complaints by `tag`") + xlab("") + ylab("Proportion of total complaints")
  
```

It looks like servicemembers have more trouble with debt collection as a segment of the population than the other groups, with over 40% of the complaints from that group being related to debt collection, 20% more than either other group. Older Americans track the same as the rest of the population across the board.


###Maps

To use the zipcode data from the CFPB dataset in a map, I needed to get some location identifiers for those zipcodes. Luckily, the `zipcode` package contains a dataset, `zipcode`, that has longititude and latitude attributes for each zipcode in the US. I merged this with my CFPB dataset below. I also removed all the non-continental observations to help with the mapping (Alaska, Puerto Rico, etc.).
```{r, message=TRUE, warning=TRUE}
data(zipcode)
zipcode <- as.data.table(zipcode)
zipcode$zip <- as.numeric(zipcode$zip)

x <- merge(x, zipcode, by.x='zipcode', by.y='zip')
x<-x[state.x !="HI"]
x<-x[state.x !="PR"]
x<-x[state.x !="AS"]
x<-x[state.x !="GU"]
x<-x[state.x !="MP"]
x<-x[state.x !="VI"]
x<-x[state.x !="AK"]
x<-x[state.y !="AK"]
x<-x[state.y !="HI"]
x<-x[state.y !="PR"]
```


The base map will be made using the shapefiles from the `ggplot2` dataset `"state"`, loaded using the `map_data()` function.
```{r, message=FALSE, warning=FALSE, include=FALSE}
us<-as.data.table(map_data("state"))
county <- as.data.table(map_data("county"))
```


A look at all the observations on a map of the US is not very helpful, since the 400k+ observations essentially paint the map solid in the populated areas of the country

Going down to a single product, we may reveal some more interesting geographical patterns. There are about 13,000 student loan complaints in the dataset.

Before starting, I have created a new dataset with the `ggplot2` function `geocode()`. This useful function allows you to get the coordinates (lat/long) for any city or address you type. I am using it to put in some of the major cities in the US.
```{r, message=FALSE, warning=FALSE}
cityName <- c("Boston", "New York", "Chicago","Dallas", "Los Angeles","San Francisco","Seattle","Portland","Detroit","Austin","Denver", "Washington, DC", "St. Louis", "Houston", "Atlanta","Philadelphia", "Miami", "Phoenix")
bigCity <- geocode(c("Boston", "New York", "Chicago","Dallas", "Los Angeles","San Francisco","Seattle","Portland","Detroit","Austin","Denver", "Washington, DC", "St. Louis", "Houston", "Atlanta","Philadelphia", "Miami","Phoenix"))
bigCity <- cbind(bigCity, cityName)

```

Mapping the student loan observations with some major cities.

```{r}
ggplot() +
  geom_polygon(data=us, aes(group=group, x=long, y=lat), fill="white", col="black", size=.6) +
  geom_point(data=x[product=="Student loan"], aes(x=longitude, y=latitude), alpha=.2, size=.5, col="red", na.rm=T) +
  geom_point(data=bigCity, aes(x=lon, y=lat), col="blue") +
  geom_text(data=bigCity, aes(x=lon, y=lat, label=cityName, hjust=1), col="navyblue") +
  coord_map() +
  theme_map() + ggtitle("CPFB Student Loan Complaints in the US")
```

Not surprisingly, the majority of student loan complaints come from areas in or close to big cities, where most people with college degrees (and thus student loans) go to live/work.


How about mortgages? Instead of nationally, I am going to look at just one state, Illinois. In the dataset, there are 855 unique zipcodes for Illinois, but over 16,000 complaints. Since the location data (lat/long) only goes to the zipcode level, there are a lot of observations hidden if we look like this on a map. To overcome this, I can use the `jitter` function of `ggplot2` to put a slight random stagger in the points, which will give a better sense of the density of complaints. 


Illinois Mortgage complaints
```{r}
ggplot() +
  geom_polygon(data=us[region=="illinois"], aes(x=long, y=lat, group=group), fill="white", col="black", size=.6) +
  geom_polygon(data=county[region=="illinois"], aes(x=long, y=lat, group=group), fill="white", col="black") +
  geom_jitter(data=x[state.y=="IL" & product=="Mortgage"], 
              aes(x=longitude, y=latitude), size=.7, alpha=.2, col="navyblue", width=.04, height=.04) +
  coord_map() +
  theme_map() + ggtitle("Illinois Mortgage Complaints")
```

Unsurprsingly, the complaints are more dense where the population is more dense, which in Illinois is the Chicago metro area. To zoom in on that area, I am going to limit the map to the seven Chicagoland counties- Cook, McHenry, DuPage, Lake, Kane, Kendall, and Will. This is a more complicated process involving the `mgcv` package, which I was able to do thanks to my question being answered on [SO](http://stackoverflow.com/questions/39069936/limit-points-on-map-plot-to-one-layer/39070058#39070058).

After some considerable fiddling with the county dataset 

```{r}
seven <- c("cook", "mchenry", "lake", "du page", "kane", "kendall", "will")

cnames <- as.data.table(aggregate(cbind(long, lat) ~ subregion, data=county[region=="illinois"], 
                    FUN=function(x)mean(range(x))))

tmp <- lapply(split(county[region=="illinois" & subregion %in% seven, .(lat,long,subregion)], county[region=="illinois" & subregion %in% seven]$subregion), function(x) {
  bind_rows(list(x, data.frame(region=NA, lat=NA, long=NA)))
})

tmp <- bind_rows(tmp)

point.filter <- in.out(as.matrix(tmp[, c("lat","long")]), 
                      as.matrix(x[state.y=="IL", .(latitude, longitude)]))

```


```{r}
ggplot() +
  geom_polygon(data=county[region=="illinois" & subregion %in% seven], 
               aes(x=long, y=lat, group=group), fill="wheat", col="black") +
  geom_count(data=x[state.y=="IL"][point.filter], aes(x=longitude, y=latitude), alpha=.2, col="royalblue")+#, size=.1, width=.02, height=.02) +
  scale_size_area(max_size=12) +
  coord_map() +
  theme_map() + ggtitle("Complaints in the Chicago Metropolitan Area")
```










