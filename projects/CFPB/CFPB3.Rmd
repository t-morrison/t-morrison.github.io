---
title: "Wells Fargo Consumer Complaints"
author: "T Morrison"
date: "September 9, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 'CairoPNG')
```

```{r, include=FALSE}
library(httr)
library(ggplot2)
library(RColorBrewer)
library(data.table)
library(ggthemes)
library(scales)
#rmarkdown::render("C:/Users/tmo/Documents/GitHub/moman822.github.io/projects/CFPB/CFPB3.Rmd")
```

Returning to the Consumer Financial Protection Bureau data from a few earlier projects, I am going to have a look at complaints regarding Wells Fargo. I read in the newspaper that Wells Fargo was fined $185 million for deceiving customers, and the CFPB was referred to in the investigation, so I want to have a look at what they saw in the data. The main issue seemed to be that Wells Fargo employees were opening accounts for people who didn't want them and pressuring people into buying new services, partly, at least, because of the way the compensation scheme incentivized this behavior.

I pulled the data straight in to R with `httr` from the CFPB API this time. It is much easier than downloading files and saving them locally then loading them into R.
```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
cfpb <- GET("https://data.consumerfinance.gov/resource/jhzv-w97w.csv")
cfpb <- content(cfpb)
setDT(cfpb)
cfpb$date_received <- as.Date(cfpb$date_received, format="%m%d%y")
```

Which companies have received the most complaints since 2011?

```{r}
head(cfpb[,.N, by=company][order(-N)], 20)

```

Wells Fargo has received the second most complaints (45,000), with Bank of America receiving the most complaints (59,000), since the CFPB started accepting them in late 2011. 

How do the complaints over time look like for these two companies?

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(cfpb[company %in% c("Wells Fargo & Company", "Bank of America")], aes(x=date_received)) +
  geom_histogram(aes(y=..count.., binwidth=30), fill="indianred", col="white") +
  facet_wrap(~company) +
  theme_solarized() +
  ggtitle("Historic Distribution of Complaints") + xlab("") + ylab("Number of Complaints") +
  theme(panel.background=element_rect(color="grey85"), strip.background=element_rect(fill=NA, color=NA))
```

There has been a very consistent frequency of complaints over the full time frame for Wells Fargo. Complaints about BoA have leveled off considerably since 2013.

What are people complaining about involving Wells Fargo? The below call will show the 10 most common issues and what fraction of the total complaints they make up.

```{r}
head(cfpb[company=="Wells Fargo & Company", ((.N)/nrow(cfpb[company=="Wells Fargo & Company"])), by=issue][order(-V1)], 10)
```

Loan issues take up almost 50% of the complaints, but the third most common complaint is for "Account opening, closing, or management", with nearly 10% of the total complaints. This is what was at the heart of the charges against Wells Fargo.

How does this compare to the structure of complaints leveled against Wells Fargo's competitors? I'll go with some big names in retail banking. The top ten retail banking institutions in the US, according to my cursory internet search:

```{r}
bigBanks <- c("Wells Fargo & Company","Bank of America","JPMorgan Chase & Co.","Citibank","U.S. Bancorp","PNC Bank N.A.","SunTrust Banks, Inc.","Capital One","TD Bank US Holding Company","Fifth Third Financial Corporation")
```

To see how each compares, I've written a `for` loop that will create a `data.table` of the top ten complaint categories for each of the banks in `bigBanks` and what proportion of total claims they made up. These ten `data.table`s are saved into a list, `banks`.

```{r}
banks <- list()
  
for(a in bigBanks) {
  df<- head(cfpb[company==a, (.N/nrow(cfpb[company == a])), by=.(issue)][order(-V1)], 10)
  banks[[length(banks)+1]] = df
}
names(banks) <- bigBanks
```


With this, I can easily plot a variety of graphs.
```{r, message=FALSE, warning=FALSE, include=FALSE}
banks.dt <- melt(banks)
setDT(banks.dt)
```

This one looks at only "Account opening, closing, or management" `issue` complaints as a percentage of total complaints for all ten banks.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(banks.dt[issue=="Account opening, closing, or management"], aes(x=L1, y=value)) +
  geom_bar(stat="identity", position="dodge", fill="indianred") +
  geom_bar(data=banks.dt[issue=="Account opening, closing, or management" & L1=="Wells Fargo & Company"], aes(x=L1, y=value), fill="cyan3", stat="identity", position="dodge") +
  scale_y_continuous(labels=scales::percent) +
  theme_solarized() +
  theme(axis.text.x=element_text(angle=45, vjust=1, hjust=1)) +
  ggtitle("Percentage of Total Complaints about Account Issues") +xlab("") + ylab("")
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
banks.dt <- banks.dt[,!2, with=F]

dat.all <- rbind(banks.dt, cbind(expand.grid(issue=levels(as.factor(banks.dt$issue)), L1=levels(as.factor(banks.dt$L1)), value=NA)))
```

Or we can look at every issue (that was in the top ten for any one bank) as a percentage of total complaints for these ten large banks.

```{r, message=FALSE, warning=FALSE, include=FALSE}
bank.issue <- unique(banks.dt$issue)

banks2 <- list()

  for(a in bigBanks) {
  df<- head(cfpb[company==a & issue %in% bank.issue, (.N/nrow(cfpb[company == a])), by=.(issue)][order(V1)],20)
  banks2[[length(banks2)+1]] = df
}
names(banks2) <- bigBanks
banks2 <- melt(banks2)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=10}
ggplot(banks2, aes(x=issue, y=value, fill=L1)) +
  geom_bar(stat="identity", position="dodge", width=.8) +
  theme(axis.text.x=element_text(angle=45, vjust=1, hjust=1)) +
  scale_fill_brewer(type="qual", palette=3, name="") +
  scale_y_continuous(labels=scales::percent) +
  ggtitle("Percentage of Total Complaints by Issue, Ten Biggest Banks") +ylab("") + xlab("") +
  coord_flip()
```

So Wells Fargo did not have a disproportionate percentage of complaints about accounted-related issues compared to its competitors. Of course, this does not fully account for each banks wide range of services, but it is definitely an interesting look. Wells Fargo and BoA have way more "Loan modification, collection, foreclosure".

There are no sub-issues in the complaint dataset for Wells Fargo account-related complaints.

```{r}
unique(cfpb[company=="Wells Fargo & Company" & issue=="Account opening, closing, or management"]$sub_issue)
```

What products are they connected to?

```{r}
unique(cfpb[company=="Wells Fargo & Company" & issue=="Account opening, closing, or management"]$product)
```


OK, so all are linked to a bank account or service. That's a pretty broad term. Another interesting variable is `complaint_what_happened` which includes a description of the situation by the person filing the complaint. Unfortunately, there are only 334 observations that have any data in this column; the rest are NA. I will try some text analysis on this at some point.






