<!DOCTYPE html>
<html>
	<title>Path 1: Country click</title>
	<head>
		<meta charset="utf-8">
		<title></title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
			
		<style>
			#plot {
				position: relative;
				height: 500px;
				width: 600px;
				background-color: aqua;
			}
			#buttonsDiv {
				position: static;
				top: 0%;
				left: 420px;
				width: 100px;
			}
			#info {
				position: fixed;
				top:0;
				left: 615px;
				
				
			}
			p {
				width: 600px
			}
			ul {
				width: 570px
			}
		</style>
			
	</head>

	<body>
	
		<div id='plot'></div>
		
		<div id='buttonsDiv'>
			<ul id='buttons'>
				<!--
				<li><button onClick="companyButtonFunction('BP')">BP</button></li>
				<li><button onClick="companyButtonFunction('Shell')">Shell</button></li>
				-->
			</ul>
		</div>
		<div id='info'>
			<p>
			This interactive data explorer is a template for an application that could be used to display payments to governments reports in a dynamic 
			and easily updateable way. The data that underlies this sample can be found 
			<a href="https://docs.google.com/spreadsheets/d/1H13ML4M2KrHmYeUpm0W_reHnhtwyMbsxsQDkW39drTU/edit?usp=sharing">here</a>. <br><br>
			
			The data explorer is designed such that when new data is added to the master data file, the data explorer will automatically update its
			layout to reflect that new data, be it data for a new company or for a company's operations in a new country. This way, the data collection
			does not depend on solely one organization; as long as it is added in the correct format, it can simply be re-uploaded to wherever the app is 
			hosted.
			<br><br>
			This version of the data explorer has the following features:
			<ul>
				<li>Company buttons: will show the countries in which that company has payment data and the total amount</li>
				<li>Clickable bars: clicking on a country bar in the company view will show the different governments the company paid in that country</li>
				<li>Responsive bars: hovering over a bar will highlight it and show an infotip with the exact amount in the bar</li>
				<li>Scaling axes: each </li>
			</ul>
			<br>
			A full-featured version could include:
			<ul>
				<li>Breakdowns by government and payment type (royalty, taxes, etc.) as a stacked bar chart or pie chart</li>
				<li>Smooth transitions between different data views</li>
				<li>Dropdown menu for company selection</li>
				<li>Possible country view with payments by company</li>
				<li>Improved and customizable styling</li>
				<li>Many other customizations as needed</li>
			</ul>
			
			</p>
		
		</div>
		<script type="text/javascript">
	//Setup//		
			var margin = {top: 100, bottom: 20, left: 100, right: 100}
			
			var svgClientSize = d3.select('#plot').node().getBoundingClientRect();
			
			var width = svgClientSize.width - margin.left - margin.right
			var height = svgClientSize.height - margin.top - margin.bottom
			
			var svg = d3.select('#plot').append('svg')
							.attr('id', 'mainPlot')
							.attr('width', width + margin.left + margin.right)
							.attr('height', height + margin.top + margin.bottom)
						.append('g')
							.attr('transform', 'translate('+ margin.left +','+ margin.top +')')
							.attr('id','mainG')
			
			
			var xScale //= d3.scaleLinear()
				  //		.domain([0,200])		//needs new inputs
				  //		.range([0, width]);

			var yScale //= d3.scaleLinear()
				  //		.domain([0,200])		//needs new inputs
				  //		.range([height, 0]);
			var yHeight
			var BP
			var Shell
			var mydata
			var subset
			var companyButtonFunction
			var byCompanyCountry
			var names
			var selectID
			var byCompanyCountryGovt
			var stackData
			var tooltip = d3.select("body")
										.append("div")
										.attr('class','tooltip')
										.style('color','black')
										.style("position", "absolute")
										.style("z-index", "10")
										.style('background-color','white')
	//End setup//
	
	//Make buttons dynamically
			d3.csv('sampleData.csv', function(data){
				names = d3.map(data, function(d){return d.Company;}).keys()
								
				for(i=0; i < names.length; i++) {
					d3.select('#buttons').append('li').append('button').text(names[i]).attr('onClick','companyButtonFunction("'+names[i]+'")')
				}
				
			});
		

	//Get data
			d3.csv('https://docs.google.com/spreadsheets/d/1H13ML4M2KrHmYeUpm0W_reHnhtwyMbsxsQDkW39drTU/pub?gid=0&single=true&output=csv', function(data) {
				mydata = data
											 
		//set up scales				
			
			
		//sort data			
			//BP = mydata.filter(function(entry) { return entry.Company === 'BP' })
			//Shell = mydata.filter(function(entry) { return entry.Company === 'Shell' })
				
				byCompanyCountry = d3.nest()
								.key(function(d){return d.Company})
								.key(function(d){return d.Country})
								.rollup(function(v){return d3.sum(v, function(d){return d.Amount})})
								.entries(mydata)
				
				xScale = d3.scaleLinear()
						.domain([0,byCompanyCountry])
						.range([0,width])
				
				
				
		//make the plot
				companyButtonFunction = function(company) {
					d3.selectAll('rect').remove()
					d3.select('#yAxis').remove()
					d3.selectAll('text').remove()
							
					yScale = d3.scaleLinear()
							.domain([0,
									d3.max(byCompanyCountry.filter(function(entry){return entry.key===company})[0].values, /// input here
											  function(d) {return Number(d.value)}) 
									])
							.range([height, 0]);
					yHeight = d3.scaleLinear()
							.domain([0,
									d3.max(byCompanyCountry.filter(function(entry){return entry.key===company})[0].values, /// input here
											  function(d) {return Number(d.value)}) 
									])
							.range([0, height]);
					yAxis = d3.axisLeft(yScale)
				
			//company plots with country bars	
					svg.selectAll('rect')
						.data(byCompanyCountry.filter(function(entry){return entry.key===company})[0].values)				/// input here
						.enter()
						.append('rect')
							.attr('x', function(d,i){return (i * 100)+20})//d.values.length)
							.attr('y', function(d){return yScale(d.value)})
							.attr('height', (function(d){return yHeight(d.value)}))
							.attr('width',50)
							.attr('id', function(d){return d.key})
						.on('mouseover', function(d,i) {
							d3.select(this)
							  //.transition()
							  .attr('fill','red')
							d3.select('.tooltip')
								tooltip.transition()
									.duration(200)
									.style('visibility','visible')
									.style('opacity',1)
								tooltip.html('<b>$'+Math.round(Number(eval(d.value))).toLocaleString()+' million</b>')
									.style('font-size','16px')
									.style('font-family','sans-serif')
									.style("left", (d3.event.pageX + 8) + "px")
									.style("top", (d3.event.pageY - 35) + "px")
							})
						.on('mouseout', function(d,i) {
							d3.select(this)
							  .transition()
							  .attr('fill','black')
							tooltip.transition()
								.duration(400)
								.style('visibility','hidden')
							})
					svg.selectAll('text')
						.data(byCompanyCountry.filter(function(entry){return entry.key===company})[0].values)				/// input here
						.enter()
						.append('text')
							.text(function(d){return d.key})
							.attr('x', function(d,i){return (i * 100)+45})
							.attr('y', -10)
							.attr('text-anchor', 'middle')
					svg.append('g')
						.attr('id','yAxis')
						.call(yAxis)
			
					d3.select('svg').append('text')
						.attr('x',svgClientSize.width/2)
						.attr('y',margin.top/2)
						.attr('text-anchor', 'middle')
						.text(company+' Payments')
						.style('font-size','18px').style('font-family','sans-serif')						
					
					d3.select('svg').append('text')
						.attr('x',10)
						.attr('y',10)
						.attr('text-anchor','middle')
						.attr('transform','translate('+margin.left/2+','+((height/2)+margin.top)+') rotate(-90)')
						.text('Million USD')
			//company->country plots with government bars
					d3.selectAll('rect')
						.on('click', function() {
										tooltip.transition()
											.duration(400)
											.style('visibility','hidden')
										selectID = $(this).attr('id')
										d3.selectAll('rect').remove()
										d3.select('#yAxis').remove()
										d3.selectAll('text').remove()
										console.log(company)
										
										byCompanyCountryGovt = d3.nest()							//Available variables: company, selectID (clicked country)
															 .key(function(d){return d.Company})
															 .key(function(d){return d.Government})
															 .rollup(function(v){return d3.sum(v, function(d){return d.Amount})})
															 .entries(mydata.filter(function(entry){return entry.Company===company && entry.Country===selectID}))
										yScale = d3.scaleLinear()
													.domain([0,
															d3.max(byCompanyCountryGovt[0].values, function(d) {return Number(d.value)}) 
															])
													.range([height, 0]);
										yHeight = d3.scaleLinear()
													.domain([0,
															d3.max(byCompanyCountryGovt[0].values, function(d) {return Number(d.value)}) 
															])
													.range([0, height]);
										yAxis = d3.axisLeft(yScale)
										
										d3.select('svg').append('text')
														.attr('x',svgClientSize.width/2)
														.attr('y',margin.top/2)
														.attr('text-anchor', 'middle')
														.text(company+' Payments in '+selectID)
														.style('font-size','18px').style('font-family','sans-serif')
										
										d3.select('svg').append('text')
														.attr('x',10)
														.attr('y',10)
														.attr('text-anchor','middle')
														.attr('transform','translate('+margin.left/2+','+((height/2)+margin.top)+') rotate(-90)')
														.text('Million USD')
										
										svg.selectAll('rect')
											.data(byCompanyCountryGovt[0].values)
											.enter()
											.append('rect')
												.attr('x', function(d,i){return (i * 100)+20})
												.attr('y', function(d){return yScale(d.value)})
												.attr('height', function(d){return yHeight(d.value)})
												.attr('width',50)
											.on('mouseover', function(d,i) {
												d3.select(this)
												  //.transition()
												  .attr('fill','red')
												d3.select('.tooltip')
													tooltip.transition()
														.duration(200)
														.style('visibility','visible')
														.style('opacity',1)
													tooltip.html('<b>$'+Number(eval(d.value)).toLocaleString()+' million</b>')
														.style('font-size','16px')
														.style('font-family','sans-serif')
														.style("left", (d3.event.pageX + 8) + "px")
														.style("top", (d3.event.pageY - 35) + "px")
												
												})
											.on('mouseout', function(d,i) {
												d3.select(this)
												  .transition()
												  .attr('fill','black')
												tooltip.transition()
													.duration(400)
													.style('visibility','hidden')
												})
										svg.selectAll('text')
											.data(byCompanyCountryGovt[0].values)
											.enter()
											.append('text')
												.text(function(d){return d.key})
												.attr('x', function(d,i){return (i * 100)+45})
												.attr('y', -10)
												.attr('text-anchor', 'middle')
										svg.append('g')
											.attr('id','yAxis')
											.call(yAxis);
										
										
										stackData = d3.nest()
													   .key(function(d) { return d.Company; })
													   .key(function(d) {return d.Country;  })
													   .key(function(d) {return d.Government})
													   .rollup(function(v) { return d3.sum(v, function(d) { return d.Amount; }); })
													   .map(mydata);
													   
										byCompanyCountryGovt[0].values.map(function(d) { return d.key; }) //these are the current selection unique govt values
										
										var z = d3.scaleOrdinal()
													.range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
										var stack = d3.stack();

										console.log(eval('stackData.$'+company+'.$'+selectID))
										
										
										
									})
				};
					
			});
			
			

			
			
			
		</script>
	</body>


</html>