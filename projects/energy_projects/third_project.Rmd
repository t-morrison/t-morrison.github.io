---
title: "Energy Prices in the United States"
author: "T Morrison"
date: "April 8, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev='CairoPNG')
```

Continuing with the data from the EIA, I will be looking at some energy price data in the United States in this post. The data can be found [here](http://www.eia.gov/electricity/sales_revenue_price/) and contains information in the same format as the energy production data: year, state, industry sector category (see below), and price (cents/kilowatt hour) paid by different industries (residential, commercial, industrial, transportation).

Packages:
```{r, message=FALSE, warning=FALSE}
library(readxl)
library(tidyr)
library(dplyr)
library(ggplot2)
library(data.table)
library(scales)
library(ggthemes)
library(maps)
```

Loading the data requires a transformation from wide to long format with the help of `tidyr` and the `gather()` function.

```{r, message=FALSE, warning=FALSE}
priceYear <- read_excel("C:/Users/tmo/Desktop/R/priceannualenergy.xls", skip=1)
priceYear <- gather(priceYear, Sector, Price, -c(Year, State, `Industry Sector Category`))
priceYear<-data.table(priceYear)
```

Now we get 

```{r}
head(priceYear)
```



```{r, message=FALSE, warning=FALSE, include=FALSE}
MW<-c("IL","OH","WI","ND","SD","NE","KS","IA","MN","IN","MO","MI")
W<-c("AZ","CO","ID","MT","NV","NM","UT","WY","AK","CA","HI","OR","WA")
S<-c("AL","KY","MS","TN","AR","LA","OK","TX","DE","FL","GA","MD","NC","SC","VA","WV", "DC")
NE<-c("CT","ME","MA","NH","RI","VT","NJ","NY","PA")
```

Some more steps:

Setting a `Region` column in the whole dataset using the update-by-reference (`:=`) capability of `data.table` and some nested `ifelse` statements. Also changing the column names and removing some outliers where the price was extremely high.
```{r}
priceYear[, Region := ifelse(State%in%MW, "Midwest", ifelse(State%in%W, "West", ifelse(State%in%S, "South", ifelse(State%in%NE, "Northeast", "US"))))]
rm(MW,W,S,NE)
names(priceYear)<-c("Year","State","Industry","Sector","Price","Region")
priceYear$Price<-as.numeric(priceYear$Price)
priceYear<-filter(priceYear, Price<40)
priceYear<-na.omit(priceYear)
priceYear<-filter(priceYear, Price!="NA")
```

Great!
```{r}
head(priceYear)
```

###Deregulation overview

Many states in the US now have deregulated energy markets (covering electricity and/or gas), whereby the utilities' legal monopolies on selling power are dismantled. This introduces competition and companies often entice new customers with guaranteed low rates or clean energy sources. Consumers then have the choice to choose a new supplier or continue purchasing energy from the utility (the default; though the utility will likely be purchasing the energy from independent producers since they have had to sell off their generation assets).

Without going into too much detail, consumers have to pay for the electricity as well as the delivery of it. Depending on the place, a consumer will have some different options here. The EIA breaks this down into these four categories in what is now the `Industry` column in our data (described [here](https://www.eia.gov/electricity/annual/html/epa_02_03.html) at the bottom of the page):

* Full-service energy providers: sell bundled delivery and energy services to end-use customers
* Restructured retail service providers: offer competitive pricing and source options to consumers
* Energy-only providers: sell energy to end-use customers
* Delivery-only service: sale of energy delivery to customer using energy-only providers (utility or other owner of distribution infrastructure)


I couldn't find the distinction between restructured retail service providers and energy-only providers, but there are a lot of companies advertising themselves as retail service providers, while searching for "energy-only provider" did not turn up much. I'm not sure if there is any overlap between these categories or not, but I will not focus too much on energy-only providers as I'm sure the retail service provider price is combined supply and delivery while the other is not.


```{r}
dereg<- c("OR",
          "TX","MD","DC","DE",
          "IL","MI","OH",
          "NJ","NY","CT","RI","MA","NH","ME","PA")
priceYear[, Deregulated := ifelse(State %in% dereg, T, F)] #create 'Dereg' column for deregulated states
setkey(priceYear, Year) 
```


It's important to note that these deregulation efforts kicked in at different times across the country, if they did at all, so there will be some variation as to when the different types of energy providers start showing up in the graphics.

To start, here is a plot of the US average prices for the "Total Electric Industry" Industry Sector Category.
```{r}
ggplot(priceYear[Industry=="Total Electric Industry", mean(Price), by=.(Year, Sector)],
       aes(x=Year, y=V1, col=Sector)) +
  geom_line(size=.6) +
  ggtitle("Average US Energy Prices, 1990-2014") + ylab("Cents per kilowatt hour")
```


The price data is displayed in cents per kilowatt hour (kwh). In the previous post on energy production, the metric used was megawatt hours (mwh) ; there are 1000 kwhs in a mwh. Average energy use for a US household in 2014 (according to the EIA) was about 11,000 kwhs a year, or 30 kwhs a day. So, at the final average rate above for residential prices of 12.52 cents, the average US household spent roughly $3.60 a day on electricity. Doesn't seem too bad. When I was in Spain, I tracked my apartments meter semi-obsessively and averaged about 10kwh/day, which didn't include any heat or AC, for two people.

Next, I wanted to compare prices state by state. Knowing that a grid of fifty plots wouldn't be easy to interpret, I put the idea off until I came across the mapping functions of ggplot2. I was able to use the built-in US map data and the `maps` package to get a blank state map that I could tie my price data to. The data ties together with a common variable in both the map data.frame and my price data.frame (the state name in this case).

```{r}
us <- map_data("state")
us$stateid<-us$region
```


I made a little function to input a year and get back a state-by-state projection with a color gradient for average energy price:


The only argument of the function is year, a numeric which subsets the data to only look at a specific year and also changes the plot title accordingly. The dplyr piping section at the beginning subsets the data to isolate the desired Industry and Type; this is easy to change in order look at different subsets of the data. The ggplot call includes two `geom_map()` layers. The first is to the US map data and draws the empty map with the state lines; the second is to the price data and fills the states according to Price. The two data.frames are connected by map_id=stateid. Additionally, I removed Hawaii from the plotted data because it has extremely high energy prices that threw of the color scaling and Hawaii is not included in this map.


```{r}
priceYear$State <- tolower(state.name[match(priceYear$State,state.abb)])
priceYear$stateid <- priceYear$State

fun.stateplot <- function(year) {
  stateplot <- priceYear %>%
    filter(State!="HI") %>%
    filter(Year==year) %>%
    filter(Industry=="Total Electric Industry") %>%
    filter(Sector=="Residential")
  
  ggplot() + 
    geom_map(data=us, map=us,
                      aes(x=long, y=lat, map_id=stateid), fill="#ffffff", color="#ffffff", size=0.15) +
    geom_map(data=stateplot, map=us,
             aes(fill=Price, map_id=stateid), color="#ffffff", size=.15) +
    scale_fill_continuous(low='red', high='blue', guide='colorbar') +
    labs(x=NULL, y=NULL) +
    theme(panel.border=element_blank(), panel.background=element_blank(), axis.ticks=element_blank(),
          axis.text=element_blank()) +
    ggtitle(paste("US Energy Prices,",year))
}
```


The following plots are for residential energy prices. They are not on the same scale. 

```{r}
fun.stateplot(1990)
fun.stateplot(2002)
fun.stateplot(2014)
```


Very cool. At first glance, it looks like residential energy prices tightened in most of the country between 1990 and 2014. Is this correct or just due to the scale differences? Could it be a result of deregulation? I will take a look in the next post at some hard numbers to nail down how energy prices have shifted among the states in the 25 year period we have data for.